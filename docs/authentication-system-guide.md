# 青岛市农房建设管理平台 - 用户认证和权限管理系统

## 系统概述

本系统实现了完整的多角色用户认证和权限管理功能，支持青岛市农房建设管理平台的各级用户角色，包括市级、区市、镇街、村级管理员以及工匠、农户、检查员等业务角色。

## 核心功能

### 1. 多角色用户认证系统

支持以下8种用户角色：

- **超级管理员 (SUPER_ADMIN)** - 拥有所有系统权限
- **市级管理员 (CITY_ADMIN)** - 市级管理权限，可跨区域管理
- **区市管理员 (DISTRICT_ADMIN)** - 区市级管理权限
- **镇街管理员 (TOWN_ADMIN)** - 镇街级管理权限
- **村级管理员 (VILLAGE_ADMIN)** - 村级数据管理权限
- **工匠 (CRAFTSMAN)** - 工匠个人信息和相关业务权限
- **农户 (FARMER)** - 农户基础查看权限
- **检查员 (INSPECTOR)** - 质量安全检查相关权限

### 2. 权限控制系统

实现了27种细粒度权限控制：

#### 系统管理权限
- `system:admin` - 系统管理
- `user:manage` - 用户管理

#### 农房管理权限
- `house:view` - 农房查看
- `house:create` - 农房创建
- `house:edit` - 农房编辑
- `house:delete` - 农房删除
- `house:approve` - 农房审批

#### 工匠管理权限
- `craftsman:view` - 工匠查看
- `craftsman:create` - 工匠创建
- `craftsman:edit` - 工匠编辑
- `craftsman:delete` - 工匠删除
- `craftsman:approve` - 工匠审批

#### 培训管理权限
- `training:view` - 培训查看
- `training:create` - 培训创建
- `training:edit` - 培训编辑
- `training:delete` - 培训删除

#### 信用评价权限
- `credit:view` - 信用查看
- `credit:evaluate` - 信用评价
- `credit:manage` - 信用管理

#### 质量监管权限
- `inspection:view` - 检查查看
- `inspection:create` - 检查创建
- `inspection:edit` - 检查编辑
- `inspection:conduct` - 检查执行

#### 数据统计权限
- `statistics:view` - 统计查看
- `statistics:export` - 统计导出

#### 个人信息权限
- `profile:view` - 个人信息查看
- `profile:edit` - 个人信息编辑

### 3. 区域权限控制

实现了分层级的区域权限管理：

- **超级管理员和市级管理员**：可以访问所有区域数据
- **区市管理员**：可以访问本区市及下属镇街的数据
- **镇街管理员**：只能访问本镇街的数据
- **其他角色**：只能访问自己区域的数据

## 技术实现

### 后端技术栈

- **认证框架**：JWT (JSON Web Token)
- **密码加密**：bcryptjs (12轮加密)
- **数据验证**：Zod
- **数据库ORM**：Prisma
- **API框架**：Next.js App Router

### 前端技术栈

- **UI框架**：Ant Design 5.x
- **状态管理**：React Hooks
- **类型安全**：TypeScript
- **样式框架**：Tailwind CSS

### 安全特性

1. **密码安全**
   - 使用bcrypt进行密码加密
   - 12轮加密强度
   - 密码长度最少6位

2. **令牌安全**
   - JWT令牌认证
   - 7天有效期
   - 安全密钥保护

3. **权限安全**
   - 基于角色的访问控制 (RBAC)
   - API中间件权限检查
   - 前端界面权限控制

4. **数据安全**
   - 输入数据验证
   - SQL注入防护
   - 区域数据隔离

## API端点

### 认证相关

- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册 (需要管理员权限)
- `POST /api/auth/reset-password` - 密码重置 (需要管理员权限)
- `GET /api/auth/me` - 获取当前用户信息

### 用户管理

- `GET /api/users` - 获取用户列表 (需要管理员权限)

## 使用指南

### 1. 启动系统

```bash
# 安装依赖
pnpm install

# 生成数据库客户端
pnpm db:generate

# 初始化用户数据
pnpm tsx scripts/init-users.ts

# 启动开发服务器
pnpm dev
```

### 2. 访问系统

打开浏览器访问 `http://localhost:3000`

### 3. 测试账户

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 超级管理员 | admin | admin123456 | 拥有所有权限 |
| 工匠 | craftsman001 | 123456 | 工匠角色权限 |
| 检查员 | inspector001 | 123456 | 检查员权限 |

### 4. 功能演示

1. **登录功能**
   - 使用测试账户登录
   - 系统会根据角色显示不同的界面和功能

2. **用户管理** (仅管理员可见)
   - 查看用户列表
   - 创建新用户
   - 重置用户密码

3. **权限控制**
   - 不同角色看到不同的菜单
   - API访问权限自动控制

## 测试验证

### 运行测试脚本

```bash
# 测试认证系统
pnpm tsx scripts/test-auth.ts

# 验证完整系统
pnpm tsx scripts/verify-auth-system.ts

# 生成完成报告
pnpm tsx scripts/task-completion-report.ts
```

### 测试覆盖

- ✅ 用户登录认证
- ✅ 密码加密验证
- ✅ JWT令牌生成和验证
- ✅ 权限系统测试
- ✅ 区域权限控制
- ✅ 用户注册功能
- ✅ 密码重置功能
- ✅ 数据库操作
- ✅ API端点功能
- ✅ 前端组件集成

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面      │    │   API中间件     │    │   数据库层      │
│                 │    │                 │    │                 │
│ - 登录表单      │◄──►│ - 认证中间件    │◄──►│ - 用户表        │
│ - 用户管理      │    │ - 权限检查      │    │ - 角色权限      │
│ - 权限控制      │    │ - 数据验证      │    │ - 区域数据      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 扩展说明

系统设计具有良好的扩展性：

1. **角色扩展**：可以轻松添加新的用户角色
2. **权限扩展**：可以定义新的权限类型
3. **区域扩展**：支持更复杂的区域层级结构
4. **功能扩展**：可以基于现有权限系统添加新功能模块

## 总结

本用户认证和权限管理系统成功实现了青岛市农房建设管理平台的核心认证需求，提供了：

- 完整的多角色用户认证
- 细粒度的权限控制
- 分层级的区域权限管理
- 现代化的用户界面
- 完善的安全保护机制

系统已通过全面测试验证，可以投入使用并支持后续功能模块的开发。